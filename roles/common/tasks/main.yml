- name: build hosts file
  lineinfile: dest=/etc/hosts regexp='.*{{ item }}$' line="{{ hostvars[item].ansible_eth1.ipv4.address }} {{item}}" state=present
  when: hostvars[item].ansible_eth1.ipv4.address is defined
  with_items: "{{ groups['all'] }}"

- name: disable selinux
  selinux: state=disabled

- name: disable of selinux - now
  command: setenforce 0

- name: install utility programs
  yum: name={{ item }} state=present
  with_items:
    - wget
    - screen
    - epel-release
    - git
    - vim
    - centos-release-gluster
    - iptables
    - iptables-utils
    - iptables-services
    - ncurses-term

- name: install glusterfs client
  yum: name=glusterfs-client state=present

- name: setup kubernetes repo
  copy: src=kubernetes.repo owner=root group=root dest=/etc/yum.repos.d

- name: Ensure net.bridge.bridge-nf-call-iptables is set. See kubeadm
  copy: src=k8s.conf owner=root group=root dest=/etc/sysctl.d/k8s.conf

- name: install kube components
  command: yum -y install yum-versionlock docker kubelet-1.5.4-0 kubectl-1.5.4-0 kubernetes-cni-0.3.0.1-0.07a8a2 http://yum.kubernetes.io/pool/082436e6e6cad1852864438b8f98ee6fa3b86b597554720b631876db39b8ef04-kubeadm-1.6.0-0.alpha.0.2074.a092d8e0f95f52.x86_64.rpm

- name: lock the version of kubernetes programs so that they are not upgraded
  command: yum versionlock add kubectl kubelet kubernetes-cni kubeadm

- name: fix kubelet service init
  lineinfile:
      dest: /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
      insertafter: '^Environment=\"KUBELET_AUTHZ_ARGS'
      line: 'Environment="KUBELET_EXTRA_ARGS=--cgroup-driver=systemd"'

- name: reload systemd
  command: /usr/bin/systemctl --system daemon-reload

- name: enable kube services
  service: name={{ item }} state=started enabled=yes
  with_items:
    - docker
    - kubelet

- name: save iptables
  command: service iptables save

- name: configure dm_snapshot module
  copy: src=dm_snapshot.conf owner=root group=root mode=644 dest=/etc/modules-load.d

